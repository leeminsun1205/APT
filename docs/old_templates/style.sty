% customtitlepage.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{customtitlepage}[2024/03/15 Custom Title Page Style]

% --- Package Dependencies ---
\RequirePackage{geometry}
\RequirePackage{graphicx}
\RequirePackage[svgnames]{xcolor} % For red!50!black etc.
\RequirePackage{amsmath} % For \texttt
\RequirePackage{textpos} % For textblock
\RequirePackage{fancyhdr}
% \RequirePackage{etoolbox} % For \AtBeginDocument if strictly needed for geometry, often not.
\RequirePackage{hyperref} % For \hypersetup

% --- Make @ a letter for internal commands ---
\makeatletter

% --- User-settable definitions (Title Page Specific) ---
% These will be set by the user in their main .tex file using \coursetitle{}, \professor{}, etc.
\newcommand{\coursetitle}[1]{\def\@coursetitle{#1}}
\newcommand{\professor}[1]{\def\@professor{#1}}
\newcommand{\place}[1]{\def\@place{#1}}
\newcommand{\reportname}[1]{\def\@reportname{#1}}
\newcommand{\group}[1]{\def\@group{#1}} % For group name above authors if used

% Provide default empty definitions so they don't cause errors if not set by user
\@ifundefined{@coursetitle}{\def\@coursetitle{Computer Graphics}}{}
\@ifundefined{@professor}{\def\@professor{PhD. Cáp Phạm Đình Thăng}}{}
\@ifundefined{@place}{\def\@place{Ho Chi Minh City}}{}
\@ifundefined{@reportname}{\def\@reportname{}}{} % Often empty
\@ifundefined{@group}{\def\@group{}}{} % Often empty
\@ifundefined{@date}{\def\@date{\today}}{}


% --- Font and Layout Settings (from your original preamble) ---
% Fonts
% \renewcommand{\rmdefault}{ptm}
\renewcommand{\sfdefault}{phv}

% Page geometry (set by the package, can be overridden in main doc *after* loading)
\geometry{
    verbose=true,
    letterpaper,
    textheight=9in,
    textwidth=7in, % Important for author line breaking
    top=1in,
    headheight=14pt,
    headsep=25pt,
    footskip=30pt
}

\widowpenalty=10000
\clubpenalty=10000
\flushbottom
\sloppy

% Fancyhdr setup
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0.4pt}
\fancyheadoffset{0pt}
% You might want to make these configurable via new commands
\rhead{\scshape \footnotesize test}
% \newcommand{\shorttitle}[1]{\def\@shorttitle{#1}\chead{\@shorttitle}} % Example
\cfoot{\thepage}

% Hypersetup
\hypersetup{
    colorlinks,
    linkcolor={red!50!black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}
}

% --- Optional Background Setup ---
\newif\ifcustomtitle@backgroundenabled
\DeclareOption{background}{\customtitle@backgroundenabledtrue}
\ProcessOptions\relax

\ifcustomtitle@backgroundenabled
    \RequirePackage{background} % Load background only if option is used
    \backgroundsetup{ % Default background setup
        scale=1,
        color=black,
        opacity=1,
        angle=0,
        contents={% Default placeholder, user might need to change path or content
                \includegraphics[width=\paperwidth,height=\paperheight]{logos/background.png}
            }
    }
    \newcommand{\ApplyBackgroundToPage}{\BgThispage}
\else
    \newcommand{\ApplyBackgroundToPage}{} % Does nothing if background option not used
\fi
% User can customize background further in main doc if needed

% --- Font size redefinitions (from your original preamble) ---
\renewcommand{\normalsize}{%
    \@setfontsize\normalsize\@xpt\@xipt
    \abovedisplayskip      7\p@ \@plus 2\p@ \@minus 5\p@
    \abovedisplayshortskip \z@ \@plus 3\p@
    \belowdisplayskip      \abovedisplayskip
    \belowdisplayshortskip 4\p@ \@plus 3\p@ \@minus 3\p@
}
% \normalsize % Apply immediately

\newcommand{\medium}{%
    \@setfontsize\medium\@xipt{20}%
    \abovedisplayskip      2\p@ \@plus 2\p@ \@minus 2\p@
    \abovedisplayshortskip \z@ \@plus 1\p@
    \belowdisplayskip      \abovedisplayskip
    \belowdisplayshortskip 2\p@ \@plus 3\p@ \@minus 3\p@
}
\renewcommand{\small}{%
    \@setfontsize\small\@ixpt\@xpt
    \abovedisplayskip      6\p@ \@plus 1.5\p@ \@minus 4\p@
    \abovedisplayshortskip \z@  \@plus 2\p@
    \belowdisplayskip      \abovedisplayskip
    \belowdisplayshortskip 3\p@ \@plus 2\p@   \@minus 2\p@
}
\renewcommand{\footnotesize}{\@setfontsize\footnotesize\@ixpt\@xpt}
\renewcommand{\scriptsize}{\@setfontsize\scriptsize\@viipt\@viiipt}
\renewcommand{\tiny}{\@setfontsize\tiny\@vipt\@viipt}
\renewcommand{\medium}{\@setfontsize\medium\@xiipt{14}}
\renewcommand{\large}{\@setfontsize\large\@xiipt{15}}
\renewcommand{\Large}{\@setfontsize\Large\@xivpt{16}}
\renewcommand{\LARGE}{\@setfontsize\LARGE\@xviipt{18}}
\renewcommand{\huge}{\@setfontsize\huge\@xxpt{20}}
\renewcommand{\Huge}{\@setfontsize\Huge\@xxvpt{22}}

% --- Section redefinitions (from your original preamble) ---
\providecommand{\section}{}
\renewcommand{\section}{%
    \@startsection{section}{1}{\z@}%
    {-0.8ex \@plus -0.2ex \@minus -0.1ex}%
    {0.6ex \@plus 0.2ex \@minus 0.1ex}%
    {\LARGE\bf\raggedright}%
}
% ... (add \subsection, \subsubsection etc. if you customized them too)

% --- Title Making Logic ---
% Counter for authors per line for "groups of 3"
\newcounter{customtitle@authoronthisline}

% Rules for box at top/bottom of title block
\newcommand{\@customtitle@topbar}{%
    \vskip 0.15in%
    \hrule height 2\p@%
    \vskip 0.1in%
    \vskip -\parskip%
}
\newcommand{\@customtitle@bottombar}{%
    \vskip 0.29in%
    \vskip -\parskip%
    \hrule height 2\p@%
    \vskip 0.01in%
}

% Hook for elements BEFORE the main author/title block (e.g., logos, university header)
\newcommand{\@customtitle@maketitlehook}{}
\newcommand{\titlepagepreamble}[1]{\renewcommand{\@customtitle@maketitlehook}{#1}}

% \maketitle redefinition
\renewcommand{\maketitle}{%
    \par%
    \begingroup%
    \ApplyBackgroundToPage % Apply background if option was chosen and command defined
    \renewcommand{\thefootnote}{\fnsymbol{footnote}}%
    \renewcommand{\@makefnmark}{\hbox to \z@{$^{\@thefnmark}$\hss}}%
    \long\def\@makefntext##1{%
        \parindent 1em\noindent%
        \hbox to 1.8em{\hss $\m@th ^{\@thefnmark}$}##1%
    }%
    \thispagestyle{empty}%
    \@customtitle@maketitlehook % Execute pre-title elements (logos, etc.)
    % The main title block content generation:
    \vbox{%
        \hsize\textwidth%
        \linewidth\hsize%
        % \vskip 0.5in % Initial vskip, adjust if preamble hook adds space
        \centering%
        {\Huge \scshape \@group\par}% Group name, if provided
        \vskip 0.1in%
        \setcounter{customtitle@authoronthisline}{1}% The first author is #1
        \def\And{%
            \end{tabular}%
            % Check if the author *just completed* was the 3rd, 6th, etc. on a line
            \ifnum\numexpr\value{customtitle@authoronthisline}-(\value{customtitle@authoronthisline}/3)*3\relax=0
                \hfil\linebreak[4]\hfil % Force a new line
            \else
                \hfil\linebreak[0]\hfil % Allow staying on the same line
            \fi
            \stepcounter{customtitle@authoronthisline}% Increment for the *next* author
            \begin{tabular}[t]{c}\bfseries\rule{\z@}{24\p@}\ignorespaces%
                }%
                \def\AND{% Stronger break, always new line
            \end{tabular}\hfil\linebreak[4]\hfil%
            \stepcounter{customtitle@authoronthisline}%
            \begin{tabular}[t]{c}\bfseries\rule{\z@}{24\p@}\ignorespaces%
        }%
        \begin{tabular}[t]{c}\bfseries\rule{\z@}{24\p@}\@author\end{tabular}% The \@author content itself
        \vskip 0.5in \@minus 0.1in%
        \@customtitle@topbar%
        \centering%
        {\Huge \scshape \@title\par}%
        \@customtitle@bottombar%
        \vskip 0.05in%
            {\large \textsc{\@coursetitle}\par}
        \vskip 0.1cm
            {\large \textsc{Instructor: \@professor}\par}
        \vskip 3cm
            {\large \textsc{\@place}\par}
        \vskip 0.1cm
            {\large \textsc{\@date}\par}
        \vskip 0.2in
    }% End of \vbox for title content
    \@thanks%
    \endgroup%
    \let\maketitle\relax%
    \let\thanks\relax%
}

% --- Abstract and Keyword Styling (from your original preamble) ---
\renewenvironment{abstract}
{%
    \centerline%
    {\bfseries \scshape \LARGE Abstract}% Changed from \huge to \Large based on common practice
    \medium % Font for abstract text
    \begin{quote}%
        }
        {%
    \end{quote}%
}

\def\keywordname{{\bfseries \emph{Keywords}}}%
\def\keywords#1{\par\addvspace\medskipamount{\rightskip=0pt plus1cm%
        \def\and{\ifhmode\unskip\nobreak\fi\ $\cdot$ % Local redef of \and for keyword list
        }\noindent\keywordname\enspace\ignorespaces#1\par}}

% --- Restore @ to non-letter ---
\makeatother

\typeout{Package 'customtitlepage' version 1.0 loaded.}